<!--
 Copyright 2015 the original author or authors.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!doctype html>

<html class="no-js" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WikiBrowser</title>
  <link rel="stylesheet" href="css/foundation.css"/>
  <link rel="stylesheet" href="css/concept-map.css"/>
  <script src="js/vendor/modernizr.js"></script>

  <script>
    var curLang = "en";
    var curTitle = "";
    var curItemId = "";
    var curNearMatch = "";
    var dispIds = true;

    // TODO: Examine usefulness of, and possibly refactor, functionality in this handler
    window.addEventListener('load', function() {
      $('#searchButton').prop('disabled', true);
      $('#helpAboutButton').prop('disabled', false);
      $('#offCanvasList').foundation('offcanvas', 'show', 'offcanvas-overlap-left');
      $( "#wikipediaInnerFrame" ).attr("width",(window.innerWidth / 2) - 12).attr("height",window.innerHeight - 250);
    } );

    /**
     * Retrieves Wikipedia article names for a string in an input field. This method is called
     * with each keystroke in the input field
     */
    function searchArticleNameNearMatch () {
      var searchStr = $('#searchInput').val().trim();
      $('#searchDropdown').prop('disabled', true);
      $('#searchButton').prop('disabled', true);
      if (searchStr.length > 0) {
        $('#searchDropdown').prop('disabled', false);
        searchStr = searchStr.split(" ").join("%20");
        $.ajax({
              url: '/articlesearch',
              data: "title=" + searchStr + "&nearmatch=true&lang=" + curLang, //TODO: Enable user to select lanquage
              dataType: 'json',
            })
            .done(function (response) {
              for (i in response.titles) {
                var title = response.titles[i];
                if (title.toLowerCase() === $('#searchInput').val().trim().toLowerCase()) {
                  $('#searchButton').prop('disabled', false);
                  curNearMatch = title;
                }
              }
            })
            .error(function (err) {
              //alert("error: " + err);
            });
      }
    }

    /**
    /**
     * Retrieves Wikipedia article names for a string in an input field. This method is called
     * with each keystroke in the input field
     */
    function searchPopulateArticleNameMatches () {
      var searchStr = $('#searchInput').val().trim();
      if (searchStr.length > 0) {
        searchStr = searchStr.split(" ").join("%20");
        $.ajax({
              url: '/articlesearch',
              data: "title=" + searchStr + "&lang=" + curLang, //TODO: Enable user to select lanquage
              dataType: 'json',
            })
            .done(function (response) {
              $('#searchDrop').html('');
              for (i in response.titles) {
                var title = response.titles[i];
                var snippet = "<li><a href='#' onclick='loadWikipediaPageByArticleName(\"" + title + "\", \"" + curLang + "\")'>" + title + "</a></li>";
                $('#searchDrop').append(snippet);
              }
            })
            .error(function (err) {
              //alert("error: " + err);
            });
      }
    }

    /**
     * Convenience method to call multiple functions
     */
    function retrieveClaimsAndLoadPage(id, lang) {
      retrieveClaimsByItemId(id, lang);
      loadWikipediaPageByItemId(id, lang);
    }

    /**
     * Parses the
     * @param wikipageEndpointWithParams
     *
     * Examples of input include:
     * http://localhost:8080/wikipage?name=Earth&lang=en
     * http://localhost:8080/wikipage?name=Earth
     * http://localhost:8080/wikipage?name=Terre&lang=fr
     */
    function refreshClaimsWikipageEndpoint (endpointUrl) {
      // Clear the search input text field
      // TODO: Perhaps find a better place to clear the search input text field & suggestions dropdown
      $("#searchInput").val("");
      $('#searchDrop').html('');
      $('#searchButton').prop('disabled', true);
      $('#searchDropdown').prop('disabled', true);

      var endpointUrlArray = endpointUrl.split(/&|\?/);
      var articleName = "";
      var language = "";
      for (idx in endpointUrlArray) {
        var paramValueArray = endpointUrlArray[idx].split("=");
        if (paramValueArray.length == 2 && paramValueArray[0].toLowerCase() === "name") {
          articleName = paramValueArray[1];
        }
        else if (paramValueArray.length == 2 && paramValueArray[0].toLowerCase() === "lang") {
          language = paramValueArray[1];
        }
      }
      if (articleName != "") {
        refreshClaims(articleName, language);
      }
    }

    var lastArticleNameRefreshed = "";
    var lastLangRefreshed = "";

    function refreshClaims (name, lang) {
      if (name != lastArticleNameRefreshed || lang != lastLangRefreshed) {
        lastArticleNameRefreshed = name;
        lastLangRefreshed = lang;
        $.ajax({
              url: '/idlocator',
              data: "name=" + name + "&lang=" + lang + "",
              dataType: 'json',
            })
            .done(function (itemInfo) {
              retrieveClaimsByItemId(itemInfo.itemId, lang);
            })
            .error(function (err) {
              //alert("error: " + err);
            });
      }
    }

    function retrieveClaimsByItemId (id, lang) {
      // Cause Concept Map model to be updated
      // addItemId(id);

      $.ajax({
            url: '/claims',
            data: "id=" + id + "&lang=" + lang + "",
            dataType: 'json',
          })
          .done(function(data) { // Variable data contains the data we get from serverside
            populateOffCanvasList(data)
          })
          .error(function(err) {
            //alert("error: " + err);
          });
    }

    // Supply id and lang
    function loadWikipediaPageByItemId(id, lang) {
      $.ajax({
            url: '/locator',
            data: "id=" + id + "&lang=" + lang + "",
            dataType: 'json',
          })
          .done(function(itemInfo) {
            var artName = itemInfo.articleName;
            if (artName !== null) {
              $("#wikipediaInnerFrame").attr("src", "/wikipage?name=" + itemInfo.articleName + "&lang=" + lang);
            }
          })
          .error(function(err) {
            //alert("error: " + err);
          });
    }

    function loadWikipediaPageByArticleName(name, lang) {
      curLang = lang;
      $("#wikipediaInnerFrame").attr("src", "/wikipage?name=" + name.trim() + "&lang=" + lang);
    }

    function populateOffCanvasList(resp) {
      $('#offCanvasList').html(''); // Clear out off-canvas list
      $('#offCanvasList').append("<ul><li><label>Wikidata Relationships:</label></li>"); //TODO: Internationalize this label
      var title = resp.articleTitle;
      curTitle = title;
      var language = resp.lang;
      var itemId = ""
      var isProperty;

      if (title == null) title = "Wikipedia article missing";
      curItemId = resp.articleId;

      // Update concept map pin switch
      //$('#pinSwitch[checked]').prop('checked', isItemIdInConceptMap(curItemId));
      if (isItemIdInConceptMap(curItemId)) {
        $('#pinSwitch:checked').prop('checked', true);
      }
      else {
        $('#pinSwitch:checked').prop('checked', false);
      }

      $('#offCanvasTitle').text(title + (dispIds ? (" :" + curItemId) : "") + " [" + language + "]");
      for (var cIdx in resp.claim) {
        if (resp.claim[cIdx].val.length == 1) {
          itemId = resp.claim[cIdx].val[0].id;
          isProperty = itemId.substring(0, 1).toUpperCase() === "P";
          $('#offCanvasList').append("<li><a href='#' onclick='retrieveClaimsAndLoadPage(\"" + itemId + "\", \"" + language + "\")'><label>" +
              resp.claim[cIdx].prop.label + (dispIds ? (" :" + resp.claim[cIdx].prop.id) : "") + "</label><br/>" +
              resp.claim[cIdx].val[0].label + (dispIds ? (" <i>:" + itemId) : "") +
              (dispIds ? ("</i>") : "") +
              "</a></li>");
        }
        else {
          $('#offCanvasList').append("<li><label>" + resp.claim[cIdx].prop.label + (dispIds ? (" :" + resp.claim[cIdx].prop.id) : "") + "</label></li>");
          var vals = resp.claim[cIdx].val;
          for (var vIdx in vals) {
            itemId = vals[vIdx].id;
            isProperty = itemId.substring(0, 1).toUpperCase() === "P";
            $('#offCanvasList').append("  <li><a href='#' onclick='retrieveClaimsAndLoadPage(\"" + itemId + "\", \"" + language + "\")'>" +
                vals[vIdx].label + (dispIds ? (" <i>:" + itemId) : "") +
                (dispIds ? ("</i>") : "") +
                "</a></li>");
          }
          $('#offCanvasList').append("  </ul>");
          $('#offCanvasList').append("</li>");
        }
      }
      $('#offCanvasList').append("</ul>");
    }

    function retrieveLangLinks (title, lang) {
      //alert("Retrieving language links for: " + title + ", " + lang);
      var titleStr = title.split(" ").join("%20");
      $.ajax({
            url: '/langlinks',
            data: "title=" + titleStr + "&lang=" + lang + "",
            dataType: 'json',
          })
          .done(function(resp) {
            populateLangLinks(resp)
          })
          .error(function(err) {
            //alert("error: " + err);
          });
    }

    function populateLangLinks(resp) {
      if (resp.langlinks.length > 0) {
        $('#offCanvasLangLinks').html(''); // Clear out language links
        $('#offCanvasLangLinks').append("<ul><li><label>Languages:</label></li>"); //TODO: Internationalize this label
        for (var idx in resp.langlinks) {
          var langLink = resp.langlinks[idx];
          var langName = langLink.langName;
          var langAutonym = langLink.langAutonym;
          var langCode = langLink.langCode;
          var articleName = langLink.articleName;
          $('#offCanvasLangLinks').append("<li><a href='#' onclick='loadWikipediaPageByArticleName(\"" + articleName + "\", \"" + langCode + "\")'>" +
              langName + " / " + langAutonym + "</a></li>");
        }
        $('#offCanvasLangLinks').append("</ul>");
      }
    }

    function revealAboutDialog() {
      $('#aboutDialog').foundation('reveal', 'open');
    }

    function openWikidataItem() {
      window.open('https://www.wikidata.org/wiki/' + curItemId);
    }


  </script>

</head>

<body>

<!-- Top bar -->

  <nav class="top-bar" data-topbar role="navigation">
    <ul class="title-area">
      <li class="name">
        <h1><a href="#">WikiBrowser</a></h1>
      </li>
    </ul>

    <section class="top-bar-section">
      <ul class="right">
        <li><a href="#" onclick="openWikidataItem()" style="padding-left: 0px"><img src="img/wikidata-logo.png" ></a></li>
      </ul>
      <ul class="right">
        <li><a href="http://wikidata.org" target="_blank"><i>and Wikidata</i></a></li>
      </ul>
      <ul class="right">
        <li><a href="http://pivotal.io/platform" target="_blank" style="padding: 0px"><img src="img/cloudfoundry-logo.png" style="padding: 0px"></a></li>
      </ul>
      <ul class="right">
        <li><a href="http://pivotal.io/platform" target="_blank"><i>Cloud Foundry</i></a></li>
      </ul>
      <ul class="right">
        <li><a href="http://projects.spring.io/spring-boot" target="_blank" style="padding: 0px"><img src="img/spring-logo.png" style="padding: 0px"></a></li>
      </ul>
      <ul class="right">
        <li><a href="http://projects.spring.io/spring-boot" target="_blank"><i>powered by Spring Boot</i></a></li>
      </ul>
    </section>
  </nav>

  <div class="off-canvas-wrap" data-offcanvas>
    <div class="inner-wrap">
      <nav class="tab-bar">

        <section class="left-small">
          <a class="left-off-canvas-toggle menu-icon" href="#" onclick="retrieveLangLinks(curTitle, curLang)"><span></span></a>
        </section>

        <section class="middle tab-bar-section">
          <h1 id="offCanvasTitle" class="title">WikiBrowser</h1>
        </section>

        <section class="right-small">
          <a class="right-off-canvas-toggle menu-icon" href="#"><span></span></a>
        </section>
      </nav>

      <div class="row middle">
        <div class="small-12 large-12 columns">
          <input id="searchInput" type="text" style="margin-top: 10px;margin-bottom: 5px"
                 onKeyUp="searchArticleNameNearMatch()"/>
        </div>
      </div>

      <div class="row">
        <div class="switch round small-2 small-offset-1 columns">
          <input id="pinSwitch" name="pinSwitchName" type="checkbox" checked
                 style="padding: 0px;margin-top: 50px; margin-left: 0px; margin-right: 0px;">
          <label for="pinSwitch" onclick="handlePinSwitchClick()">Pin</label>
        </div>

        <div class="small-2 small-offset-0 columns">
          <button id="searchDropdown" type="button" class="tiny" disabled="true" data-dropdown="searchDrop" style="padding: 0px; margin-top: 10px; margin-left: 0px; margin-right: 0px;" onclick="searchPopulateArticleNameMatches()"><img src="img/dropdown-arrow-icon.png" width="44"/></button>
        </div>

        <div class="small-2 small-offset-0 columns">
          <button id="searchButton" type="button" class="tiny" disabled="true" style="padding: 0px;margin-top: 10px; margin-left: 0px; margin-right: 0px;" onclick="loadWikipediaPageByArticleName(curNearMatch, curLang)"><img src="img/magnifying-glass.png" width="44"/></button>
        </div>

        <div class="small-2 small-offset-2 columns">
          <button id="helpAboutButton" type="button" class="tiny" disabled="false" style="padding: 0px;margin-top: 10px; margin-left: 0px; margin-right: 0px;" onclick="revealAboutDialog()"><img src="img/question-mark.png" width="44"/></button>
        </div>

        <ul id="searchDrop" class="f-dropdown" data-options="align:left" data-dropdown-content aria-hidden="true" tabindex="-1">
          <!-- This list is dynamically populated -->
        </ul>
      </div>

      <aside class="left-off-canvas-menu">
        <ul id="offCanvasLangLinks" class="off-canvas-list">
          <!-- This list is dynamically populated -->
        </ul>
      </aside>

      <aside class="right-off-canvas-menu">
        <ul id="offCanvasList" class="off-canvas-list">
          <!-- This list is dynamically populated -->
        </ul>
      </aside>

      <a class="exit-off-canvas"></a>

      <section class="main-section">
        <ul class="small-block-grid-2">
          <li>
            <div id="conceptMap"/>
          </li>
          <li>
            <iframe id="wikipediaInnerFrame" src="/wikipage?name=Earth&lang=en" frameborder="0" scrolling="yes" width="500" onload="refreshClaimsWikipageEndpoint(this.contentWindow.location.href)"></iframe>
          </li>
        </ul>
      </section>
    </div>
  </div>

  <div id="aboutDialog" class="reveal-modal large" data-reveal aria-labelledby="aboutDialogTitle" aria-hidden="true" role="dialog">
    <div align="center">
      <h3 id="aboutDialogTitle">About WikiBrowser</h3>
      <img src="img/wikibrowser-logo-347.png" >
      <p>Version 1.0</p>
      <p>Developed by <a href="https://twitter.com/javafxpert"
                         target="_blank">James L. Weaver</a></p>
      <p>Licensed under the Apache License, Version 2.0</p>
      <a class="close-reveal-modal" aria-label="Close">&#215;</a>
    </div>
  </div>


  <script src="js/d3.min.js"></script>
  <script src="js/vendor/jquery.js"></script>
  <script src="js/foundation.min.js"></script>
  <script>
    //$(document).foundation();
    $(document).foundation({
      offcanvas : {
        // Sets method in which offcanvas opens.
        // [ move | overlap_single | overlap ]
        open_method: 'overlap_single',
        // Should the menu close when a menu link is clicked?
        // [ true | false ]
        close_on_click : false
      }
    });

  </script>
  <script>
    // Throttled resize function
    $(window).on('resize', Foundation.utils.throttle(function(e){
      $( "#wikipediaInnerFrame" ).attr("width",(window.innerWidth / 2) - 12).attr("height",window.innerHeight - 250);
    }, 300));

    $("input").keypress(function(event){
      var keycode = (event.keyCode ? event.keyCode : event.which);
      if(keycode == '13'){
        if (curNearMatch.length > 0) {  //TODO: Also check if Search button is enabled (or better yet, a common "is" method?
          loadWikipediaPageByArticleName(curNearMatch, curLang);
        }
      }
      else {
        searchArticleNameNearMatch();
      }
    });
  </script>

  <!-- Concept Map related functionality -->
  <script>
    var w = window,
        d = document,
        e = d.documentElement,
        g = d.getElementsByTagName('body')[0],
        x = w.innerWidth || e.clientWidth || g.clientWidth,
        y = w.innerHeight|| e.clientHeight|| g.clientHeight;

    var width = 500,
        height = 400;

    function loadConceptMap(itemsArg) {
      $( "#conceptMap" ).empty();
      var svg = d3.select("#conceptMap").append("svg")
        .attr("width", x / 2)
        .attr("height", y - 250)
        .style("background" ,"#FFFFFF");

      var force = d3.layout.force()
          .size([width, height])
          .linkDistance(150)
          .charge(-450);

     var graphServiceUrl = "http://wikibrowserservice.cfapps.io/graph?items=";

      d3.json(graphServiceUrl + itemsArg, function (error, graph) {
        if (error) throw error;

        var nodeById = d3.map();

        graph.nodes.forEach(function (node) {
          nodeById.set(node.id, node);
        });

        graph.links.forEach(function (link) {
          link.source = nodeById.get(link.source);
          link.target = nodeById.get(link.target);
        });

        // TODO: Decide whether to enable
        //var drag = force.drag()
        //    .on("dragstart", dragstart);

        force
            .nodes(graph.nodes)
            .links(graph.links)
            .on("tick", tick)
            .start();

        // Per-type markers, as they don't inherit styles.
        svg.append("defs").selectAll("marker")
            .data(["default"])
            .enter().append("marker")
            .attr("id", String)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 30)
            .attr("refY", -4.5)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5");

        var path = svg.append("svg:g").selectAll("path")
            .data(force.links())
            .enter().append("svg:path")
            .attr("class", function(d) { return "link " + d.type; })
            .attr("id",function(d,i) { return "linkId_" + i; })
            //.attr("marker-end", function(d) { return "url(#" + d.type + ")"; });
            .attr("marker-end", function(d) { return "url(#" + "default" + ")"; });
        var linktext = svg.append("svg:g").selectAll("g.linklabelholder").data(force.links());

        linktext.enter().append("g").attr("class", "linklabelholder")
            .append("text")
            .attr("class", "linklabel")
            .style("font-size", "8px")
            .attr("x", "30")
            .attr("y", "-20")
            .attr("text-anchor", "start")
            .style("fill","#000")
            .append("textPath")
            //.attr("xlink:href",function(d) { return "hello";})
            .attr("xlink:href",function(d,i) { return "#linkId_" + i;})
            .text(function(d) {
              return d.type;
            });


        var circle = svg.append("g").selectAll("circle")
            .data(force.nodes())
            .enter().append("circle")
            .attr("r", 20)
            .on("click", handleNodeClick)
            .on("touch", handleNodeClick)
            .call(force.drag);

        var text = svg.append("g").selectAll("text")
            .data(force.nodes())
            .enter().append("text")
            .attr("x", -12)
            .attr("y", ".31em")
            .text(function (d) {
              return d.title;
            });

        // Use elliptical arc path segments to doubly-encode directionality.
        function tick() {
          path.attr("d", linkArc);
          circle.attr("transform", transform);
          text.attr("transform", transform);
        }

        function linkArc(d) {
          var dx = d.target.x - d.source.x,
              dy = d.target.y - d.source.y,
              dr = Math.sqrt(dx * dx + dy * dy);
          return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
        }

        function transform(d) {
          return "translate(" + d.x + "," + d.y + ")";
        }

        function dragstart(d) {
          d3.select(this).classed("fixed", d.fixed = true);
        }
      });
    }

    // Contains item IDs to display in concept map
    var itemIdArray = ["Q2"];


    loadConceptMap(itemIdArray.join(","));

    function addItemId(itemId) {
      if (itemId.length > 0) {
        if (itemIdArray.indexOf(itemId) < 0) {
          itemIdArray.push(itemId);
        }
      }
      loadConceptMap(itemIdArray.join(","));
    }

    function removeItemId(itemId) {
      if (itemId.length > 0) {
        var index = itemIdArray.indexOf(itemId);
        if (index > -1) {
          itemIdArray.splice(index, 1);
        }
      }
      loadConceptMap(itemIdArray.join(","));
    }

    function isItemIdInConceptMap(itemId) {
      return itemIdArray.indexOf(itemId) > -1;
    }

    function handlePinSwitchClick() {
      var isOn = $('#pinSwitch').is(':checked');
      if (isOn) {
        removeItemId(curItemId);
      }
      else {
        addItemId(curItemId);
      }
    }

    function handleNodeClick(d) {
      retrieveClaimsAndLoadPage(d.id, curLang);
    }

  </script>

</body>
</html>
