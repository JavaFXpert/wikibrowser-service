<!--
 Copyright 2015 the original author or authors.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!doctype html>

<html class="no-js" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WikiBrowser</title>
  <link rel="stylesheet" href="css/foundation.css"/>
  <script src="js/vendor/modernizr.js"></script>

  <script>
    var curLang = "en";
    var curTitle = "";
    var curNearMatch = "";
    var dispIds = true;

    // TODO: Examine usefulness of, and possibly refactor, functionality in this handler
    window.addEventListener('load', function() {
      $('#searchButton').prop('disabled', true);

      $( "#wikipediaInnerFrame" ).attr("width",window.innerWidth - 0).attr("height",window.innerHeight - 60);
    } );

    /**
     * Retrieves Wikipedia article names for a string in an input field. This method is called
     * with each keystroke in the input field
     */
    function searchArticleNameNearMatch () {
      var searchStr = $('#searchInput').val().trim();
      $('#searchDropdown').prop('disabled', true);
      $('#searchButton').prop('disabled', true);
      if (searchStr.length > 0) {
        $('#searchDropdown').prop('disabled', false);
        searchStr = searchStr.split(" ").join("%20");
        $.ajax({
              url: '/articlesearch',
              data: "title=" + searchStr + "&nearmatch=true&lang=" + curLang, //TODO: Enable user to select lanquage
              dataType: 'json',
            })
            .done(function (response) {
              for (i in response.titles) {
                var title = response.titles[i];
                if (title.toLowerCase() === $('#searchInput').val().trim().toLowerCase()) {
                  $('#searchButton').prop('disabled', false);
                  curNearMatch = title;
                }
              }
            })
            .error(function (err) {
              //alert("error: " + err);
            });
      }
    }

    /**
    /**
     * Retrieves Wikipedia article names for a string in an input field. This method is called
     * with each keystroke in the input field
     */
    function searchPopulateArticleNameMatches () {
      var searchStr = $('#searchInput').val().trim();
      if (searchStr.length > 0) {
        searchStr = searchStr.split(" ").join("%20");
        $.ajax({
              url: '/articlesearch',
              data: "title=" + searchStr + "&lang=" + curLang, //TODO: Enable user to select lanquage
              dataType: 'json',
            })
            .done(function (response) {
              $('#searchDrop').html('');
              for (i in response.titles) {
                var title = response.titles[i];
                var snippet = "<li><a href='#' onclick='loadWikipediaPageByArticleName(\"" + title + "\", \"" + curLang + "\")'>" + title + "</a></li>";
                $('#searchDrop').append(snippet);
              }
            })
            .error(function (err) {
              //alert("error: " + err);
            });
      }
    }

    /**
     * Convenience method to call multiple functions
     */
    function retrieveClaimsAndLoadPage(id, lang) {
      retrieveClaimsByItemId(id, lang);
      loadWikipediaPageByItemId(id, lang);
    }

    /**
     * Parses the
     * @param wikipageEndpointWithParams
     *
     * Examples of input include:
     * http://localhost:8080/wikipage?name=Earth&lang=en
     * http://localhost:8080/wikipage?name=Earth
     * http://localhost:8080/wikipage?name=Terre&lang=fr
     */
    function refreshClaimsWikipageEndpoint (endpointUrl) {
      // Clear the search input text field
      // TODO: Perhaps find a better place to clear the search input text field & suggestions dropdown
      $("#searchInput").val("");
      $('#searchDrop').html('');
      $('#searchButton').prop('disabled', true);
      $('#searchDropdown').prop('disabled', true);

      var endpointUrlArray = endpointUrl.split(/&|\?/);
      var articleName = "";
      var language = "";
      for (idx in endpointUrlArray) {
        var paramValueArray = endpointUrlArray[idx].split("=");
        if (paramValueArray.length == 2 && paramValueArray[0].toLowerCase() === "name") {
          articleName = paramValueArray[1];
        }
        else if (paramValueArray.length == 2 && paramValueArray[0].toLowerCase() === "lang") {
          language = paramValueArray[1];
        }
      }
      if (articleName != "") {
        refreshClaims(articleName, language);
      }
    }

    var lastArticleNameRefreshed = "";
    var lastLangRefreshed = "";

    function refreshClaims (name, lang) {
      if (name != lastArticleNameRefreshed || lang != lastLangRefreshed) {
        lastArticleNameRefreshed = name;
        lastLangRefreshed = lang;
        $.ajax({
              url: '/idlocator',
              data: "name=" + name + "&lang=" + lang + "",
              dataType: 'json',
            })
            .done(function (itemInfo) {
              retrieveClaimsByItemId(itemInfo.itemId, lang);
            })
            .error(function (err) {
              //alert("error: " + err);
            });
      }
    }

    function retrieveClaimsByItemId (id, lang) {
      //alert("Retrieving claims for: " + id);
      $.ajax({
            url: '/claims',
            data: "id=" + id + "&lang=" + lang + "",
            dataType: 'json',
          })
          .done(function(data) { // Variable data contains the data we get from serverside
            populateOffCanvasList(data)
          })
          .error(function(err) {
            //alert("error: " + err);
          });
    }

    // Supply id and lang
    function loadWikipediaPageByItemId(id, lang) {
      $.ajax({
            url: '/locator',
            data: "id=" + id + "&lang=" + lang + "",
            dataType: 'json',
          })
          .done(function(itemInfo) {
            var artName = itemInfo.articleName;
            if (artName !== null) {
              $("#wikipediaInnerFrame").attr("src", "/wikipage?name=" + itemInfo.articleName + "&lang=" + lang);
            }
          })
          .error(function(err) {
            //alert("error: " + err);
          });
    }

    function loadWikipediaPageByArticleName(name, lang) {
      curLang = lang;
      $("#wikipediaInnerFrame").attr("src", "/wikipage?name=" + name.trim() + "&lang=" + lang);
    }

    function populateOffCanvasList(resp) {
      $('#offCanvasList').html(''); // Clear out off-canvas list
      var title = resp.articleTitle;
      curTitle = title;
      var language = resp.lang;
      var itemId = ""
      var isProperty;

      if (title == null) title = "Wikipedia article missing";
      $('#offCanvasTitle').text(title + (dispIds ? (" :" + resp.articleId) : "") + " [" + language + "]");
      for (var cIdx in resp.claim) {
        if (resp.claim[cIdx].val.length == 1) {
          itemId = resp.claim[cIdx].val[0].id;
          isProperty = itemId.substring(0, 1).toUpperCase() === "P";
          $('#offCanvasList').append("<li><a href='#' onclick='retrieveClaimsAndLoadPage(\"" + itemId + "\", \"" + language + "\")'><label>" +
              resp.claim[cIdx].prop.label + (dispIds ? (" :" + resp.claim[cIdx].prop.id) : "") + "</label><br/>" +
              resp.claim[cIdx].val[0].label + (dispIds ? (" <i>:" + itemId) : "") +
              (dispIds ? ("</i>") : "") +
              "</a></li>");
        }
        else {
          $('#offCanvasList').append("<li><label>" + resp.claim[cIdx].prop.label + (dispIds ? (" :" + resp.claim[cIdx].prop.id) : "") + "</label></li>");
          var vals = resp.claim[cIdx].val;
          for (var vIdx in vals) {
            itemId = vals[vIdx].id;
            isProperty = itemId.substring(0, 1).toUpperCase() === "P";
            $('#offCanvasList').append("  <li><a href='#' onclick='retrieveClaimsAndLoadPage(\"" + itemId + "\", \"" + language + "\")'>" +
                vals[vIdx].label + (dispIds ? (" <i>:" + itemId) : "") +
                (dispIds ? ("</i>") : "") +
                "</a></li>");
          }
          $('#offCanvasList').append("  </ul>");
          $('#offCanvasList').append("</li>");
        }
      }
      $('#offCanvasList').append("</ul>");
    }

    function retrieveLangLinks (title, lang) {
      //alert("Retrieving language links for: " + title + ", " + lang);
      var titleStr = title.split(" ").join("%20");
      $.ajax({
            url: '/langlinks',
            data: "title=" + titleStr + "&lang=" + lang + "",
            dataType: 'json',
          })
          .done(function(resp) {
            populateLangLinks(resp)
          })
          .error(function(err) {
            //alert("error: " + err);
          });
    }

    function populateLangLinks(resp) {
      if (resp.langlinks.length > 0) {
        $('#offCanvasLangLinks').html(''); // Clear out language links
        $('#offCanvasLangLinks').append("<ul><li><label>Languages:</label></li>"); //TODO: Internationalize this label
        for (var idx in resp.langlinks) {
          var langLink = resp.langlinks[idx];
          var langName = langLink.langName;
          var langAutonym = langLink.langAutonym;
          var langCode = langLink.langCode;
          var articleName = langLink.articleName;
          $('#offCanvasLangLinks').append("<li><a href='#' onclick='loadWikipediaPageByArticleName(\"" + articleName + "\", \"" + langCode + "\")'>" +
              langName + " / " + langAutonym + "</a></li>");
        }
        $('#offCanvasLangLinks').append("</ul>");
      }
    }

  </script>

</head>

<body>

  <div class="off-canvas-wrap" data-offcanvas>
    <div class="inner-wrap">
      <nav class="tab-bar">

        <section class="left-small">
          <a class="left-off-canvas-toggle menu-icon" href="#" onclick="retrieveLangLinks(curTitle, curLang)"><span></span></a>
        </section>

        <section class="middle tab-bar-section">
          <h1 id="offCanvasTitle" class="title">WikiBrowser</h1>

          <div class="row">
            <div class="small-2 large-2 columns">
              <button id="searchDropdown" type="button" class="tiny" disabled="true" data-dropdown="searchDrop" onclick="searchPopulateArticleNameMatches()">v</button>
            </div>
            <div class="small-8 large-8 columns">
              <input id="searchInput" type="text" placeholder="Search" style="margin-top: 6px"
                   onKeyUp="searchArticleNameNearMatch()"/>
            </div>
            <div class="small-2 large-2 columns end">
              <button id="searchButton" type="button" class="tiny" disabled="true" onclick="loadWikipediaPageByArticleName(curNearMatch, curLang)">&gt;</button>
            </div>
          </div>

          <ul id="searchDrop" class="f-dropdown" data-options="align:left" data-dropdown-content aria-hidden="true" tabindex="-1">
            <!-- This list is dynamically populated with JQuery -->
          </ul>
        </section>

        <section class="right-small">
          <a class="right-off-canvas-toggle menu-icon" href="#"><span></span></a>
        </section>
      </nav>

      <aside class="left-off-canvas-menu">
        <ul id="offCanvasLangLinks" class="off-canvas-list">
          <!-- This list is dynamically populated with JQuery -->
        </ul>
      </aside>

      <aside class="right-off-canvas-menu">
        <ul id="offCanvasList" class="off-canvas-list">
          <!-- This list is dynamically populated with JQuery -->
        </ul>
      </aside>

      <section class="main-section">
        <iframe id="wikipediaInnerFrame" src="/wikipage?name=Earth&lang=en" frameborder="0" scrolling="yes" width="1000" onload="refreshClaimsWikipageEndpoint(this.contentWindow.location.href)"></iframe>
      </section>

      <a class="exit-off-canvas"></a>

    </div>
  </div>



    <script src="js/vendor/jquery.js"></script>
    <script src="js/foundation.min.js"></script>
    <script>
      //$(document).foundation();
      $(document).foundation({
        offcanvas : {
          // Sets method in which offcanvas opens.
          // [ move | overlap_single | overlap ]
          open_method: 'overlap_single',
          // Should the menu close when a menu link is clicked?
          // [ true | false ]
          close_on_click : false
        }
      });

    </script>
    <script>
      // Throttled resize function
      $(window).on('resize', Foundation.utils.throttle(function(e){
        $( "#wikipediaInnerFrame" ).attr("width",window.innerWidth - 0).attr("height",window.innerHeight - 60);
      }, 300));

      $("input").keypress(function(event){
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if(keycode == '13'){
          if (curNearMatch.length > 0) {  //TODO: Also check if Search button is enabled (or better yet, a common "is" method?
            loadWikipediaPageByArticleName(curNearMatch, curLang);
          }
        }
        else {
          searchArticleNameNearMatch();
        }
      });

    </script>

</body>
</html>
