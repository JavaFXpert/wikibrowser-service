<!--
 Copyright 2015 the original author or authors.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!doctype html>

<html class="no-js" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WikiBrowser</title>
  <link rel="stylesheet" href="css/foundation.css" />
  <script src="js/vendor/modernizr.js"></script>

  <script>
    window.addEventListener('load', function() {
      //alert("iframe loaded");
      retrieveClaimsByItemId("Q1", "en");

      $( "#wikipediaInnerFrame" ).attr("width",window.innerWidth - 0).attr("height",window.innerHeight - 60);
    } );

    /**
     * Convenience method to call multiple functions
     */
    function retrieveClaimsAndLoadPage(id, lang) {
      retrieveClaimsByItemId(id, lang);
      loadWikipediaPageByItemId(id, lang);
    }

    /**
     * Parses the
     * @param wikipageEndpointWithParams
     *
     * Examples of input include:
     * http://localhost:8080/wikipage?name=Earth&lang=en
     * http://localhost:8080/wikipage?name=Earth
     * http://localhost:8080/wikipage?name=Terre&lang=fr
     */
    function refreshClaimsWikipageEndpoint (endpointUrl) {
      var endpointUrlArray = endpointUrl.split(/&|\?/);

      var articleName = "";
      var language = "";
      for (idx in endpointUrlArray) {
        var paramValueArray = endpointUrlArray[idx].split("=");
        if (paramValueArray.length == 2 && paramValueArray[0].toLowerCase() === "name") {
          articleName = paramValueArray[1];
        }
        else if (paramValueArray.length == 2 && paramValueArray[0].toLowerCase() === "lang") {
          language = paramValueArray[1];
        }
      }
      if (articleName != "") {
        refreshClaims(articleName, language);
      }
    }

    var lastArticleNameRefreshed = "";
    var lastLangRefreshed = "";
    function refreshClaims (name, lang) {
      if (name != lastArticleNameRefreshed || lang != lastLangRefreshed) {
        lastArticleNameRefreshed = name;
        lastLangRefreshed = lang;
        $.ajax({
              url: '/locator',
              data: "name=" + name + "&lang=" + lang + "",
              dataType: 'json',
            })
            .done(function (itemInfo) {
              retrieveClaimsByItemId(itemInfo.itemId, lang);
            })
            .error(function (err) {
              //alert("error: " + err);
            });
      }
    }

    function retrieveClaimsByItemId (id, lang) {
      //alert("Retrieving claims for: " + id);
      $.ajax({
            url: '/claims',
            data: "id=" + id + "&lang=" + lang + "",
            dataType: 'json',
          })
          .done(function(data) { // Variable data contains the data we get from serverside
            populateOffCanvasList(data)
          })
          .error(function(err) {
            //alert("error: " + err);
          });
    }

    // Supply id and lang
    function loadWikipediaPageByItemId(id, lang) {
      $.ajax({
            url: '/locator',
            data: "id=" + id + "&lang=" + lang + "",
            dataType: 'json',
          })
          .done(function(itemInfo) { // Variable data contains the data we get from serverside
            $( "#wikipediaInnerFrame" ).attr("src", "/wikipage?name=" + itemInfo.articleName + "&lang=" + lang);
          })
          .error(function(err) {
            //alert("error: " + err);
          });

    }

    function populateOffCanvasList(resp) {
      $('#offCanvasList').html(''); // Clear out off-canvas list
      var title = resp.articleTitle;
      var language = resp.lang;
      var itemId = ""
      var isProperty;

      $('#offCanvasTitle').text(title);
      for (var cIdx in resp.claim) {
        if (resp.claim[cIdx].val.length == 1) {
          itemId = resp.claim[cIdx].val[0].id;
          isProperty = itemId.substring(0, 1).toUpperCase() === "P";
          $('#offCanvasList').append("<li><a href='#' onclick='retrieveClaimsAndLoadPage(\"" + itemId + "\", \"" + language + "\")'><label>" +
              resp.claim[cIdx].prop.label +
              ":</label><br/>" +
              (isProperty ? ("<i>" + itemId + ": ") : "") +
              resp.claim[cIdx].val[0].label +
              (isProperty ? ("</i>") : "") +
              "</a></li>");
        }
        else {
          $('#offCanvasList').append("<li><label>" + resp.claim[cIdx].prop.label + ":</label></li>");
          var vals = resp.claim[cIdx].val;
          for (var vIdx in vals) {
            itemId = vals[vIdx].id;
            isProperty = itemId.substring(0, 1).toUpperCase() === "P";
            $('#offCanvasList').append("  <li><a href='#' onclick='retrieveClaimsAndLoadPage(\"" + itemId + "\", \"" + language + "\")'>" +
                (isProperty ? ("<i>" + itemId + ": ") : "") +
                vals[vIdx].label +
                (isProperty ? ("</i>") : "") +
                "</a></li>");
          }
          $('#offCanvasList').append("  </ul>");
          $('#offCanvasList').append("</li>");
        }
      }
      $('#offCanvasList').append("</ul>");
    }
  </script>

</head>

<body>

  <div class="off-canvas-wrap" data-offcanvas>
    <div class="inner-wrap">
      <nav class="tab-bar">
        <section class="middle tab-bar-section">
          <h1 id="offCanvasTitle" class="title">WikiBrowser</h1>
        </section>

        <section class="right-small">
          <a class="right-off-canvas-toggle menu-icon" href="#"><span></span></a>
        </section>
      </nav>

      <aside class="right-off-canvas-menu">
        <ul id="offCanvasList" class="off-canvas-list">
          <!-- This menu is dynamically populated with JQuery -->
        </ul>
      </aside>

      <section class="main-section">
        <iframe id="wikipediaInnerFrame" src="/wikipage?name=universe&lang=en" frameborder="0" scrolling="yes" width="1000" onload="refreshClaimsWikipageEndpoint(this.contentWindow.location.href)"></iframe>

      </section>

      <a class="exit-off-canvas"></a>

    </div>
  </div>



    <script src="js/vendor/jquery.js"></script>
    <script src="js/foundation.min.js"></script>
    <script>
      //$(document).foundation();
      $(document).foundation({
        offcanvas : {
          // Sets method in which offcanvas opens.
          // [ move | overlap_single | overlap ]
          open_method: 'overlap',
          // Should the menu close when a menu link is clicked?
          // [ true | false ]
          close_on_click : false
        }
      });
    </script>
    <script>
      // Throttled resize function
      $(window).on('resize', Foundation.utils.throttle(function(e){
        $( "#wikipediaInnerFrame" ).attr("width",window.innerWidth - 0).attr("height",window.innerHeight - 60);
      }, 300));
    </script>

  </body>
</html>
